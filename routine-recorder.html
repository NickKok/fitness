<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine Recorder</title>
    <style>
        /* [Previous CSS remains exactly the same] */
    </style>
</head>
<body>
    <div class="container">
        <!-- [Previous HTML structure remains exactly the same] -->
    </div>

    <script>
        // Initialize variables
        let routines = [];
        let selectedRoutineId = null;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const routinesContainer = document.getElementById('routinesContainer');
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const printBtn = document.getElementById('printBtn');
        const saveBtn = document.getElementById('saveBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Load routines from localStorage
        function loadRoutines() {
            try {
                const savedData = localStorage.getItem('routines');
                if (!savedData) {
                    showMessage("No routines found. Upload a JSON file to begin.", "info");
                    return;
                }

                const parsed = JSON.parse(savedData);
                if (!Array.isArray(parsed)) {
                    throw new Error("Invalid data format");
                }

                routines = parsed;
                renderRoutines(routines);
                saveBtn.disabled = false;
            } catch (e) {
                console.error("Load error:", e);
                showMessage("Error loading routines. Please upload a valid file.", "error");
                localStorage.removeItem('routines');
            }
        }

        // Render routines list
        function renderRoutines(routinesToRender) {
            if (!routinesToRender || !Array.isArray(routinesToRender)) {
                routinesContainer.innerHTML = '<div class="no-routines">No routines available</div>';
                disableActionButtons();
                return;
            }

            routinesContainer.innerHTML = '';
            
            if (routinesToRender.length === 0) {
                routinesContainer.innerHTML = '<div class="no-routines">No routines found</div>';
                disableActionButtons();
                return;
            }

            routinesToRender.forEach((routine, index) => {
                const card = document.createElement('div');
                card.className = `routine-card ${selectedRoutineId === index ? 'selected' : ''}`;
                card.dataset.index = index;
                
                card.innerHTML = `
                    <div class="routine-header">
                        <h3 class="routine-title">${routine.name || 'Unnamed Routine'}</h3>
                        <div>${routine.exercises?.length || 0} exercises</div>
                    </div>
                    <div class="exercise-preview">
                        ${routine.exercises?.slice(0, 3).map(ex => 
                            `<span>${ex.name || 'Unnamed Exercise'}</span>`
                        ).join('') || ''}
                        ${routine.exercises?.length > 3 ? '<span>...</span>' : ''}
                    </div>
                `;

                card.addEventListener('click', () => {
                    selectedRoutineId = index;
                    document.querySelectorAll('.routine-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    enableActionButtons();
                });

                routinesContainer.appendChild(card);
            });
        }

        // Enable/disable action buttons
        function enableActionButtons() {
            editBtn.disabled = false;
            deleteBtn.disabled = false;
            printBtn.disabled = false;
            saveBtn.disabled = false;
        }

        function disableActionButtons() {
            editBtn.disabled = true;
            deleteBtn.disabled = true;
            printBtn.disabled = true;
            saveBtn.disabled = true;
        }

        // Edit routine name
        function editSelectedRoutine() {
            if (selectedRoutineId === null || !routines[selectedRoutineId]) return;
            
            const newName = prompt("Edit routine name:", routines[selectedRoutineId].name);
            if (newName && newName.trim()) {
                routines[selectedRoutineId].name = newName.trim();
                renderRoutines(routines);
                saveBtn.disabled = false;
                showMessage("Routine updated", "success");
            }
        }

        // Delete routine
        function deleteSelectedRoutine() {
            if (selectedRoutineId === null || !routines[selectedRoutineId]) return;
            
            if (confirm(`Delete "${routines[selectedRoutineId].name}"?`)) {
                routines.splice(selectedRoutineId, 1);
                selectedRoutineId = null;
                renderRoutines(routines);
                saveBtn.disabled = false;
                showMessage("Routine deleted", "success");
            }
        }

        // Print routine
        function printSelectedRoutine() {
            if (selectedRoutineId === null || !routines[selectedRoutineId]) return;
            
            const routine = routines[selectedRoutineId];
            const printWin = window.open('', '_blank');
            if (!printWin) {
                showMessage("Please allow popups to print", "error");
                return;
            }

            printWin.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${routine.name}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        h1 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>${routine.name}</h1>
                    <table>
                        <tr><th>Exercise</th><th>Reps</th><th>Time</th><th>Notes</th></tr>
                        ${routine.exercises.map(ex => `
                            <tr>
                                <td>${ex.name || ''}</td>
                                <td>${ex.reps || '-'}</td>
                                <td>${ex.time ? ex.time + 's' : '-'}</td>
                                <td>${ex.comments || '-'}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <script>
                        setTimeout(() => {
                            window.print();
                            window.close();
                        }, 200);
                    </script>
                </body>
                </html>
            `);
            printWin.document.close();
        }

        // Save routines
        function saveRoutines() {
            try {
                localStorage.setItem('routines', JSON.stringify(routines));
                showMessage("Routines saved successfully", "success");
                saveBtn.disabled = true;
            } catch (e) {
                console.error("Save error:", e);
                showMessage("Failed to save routines", "error");
            }
        }

        // Search functionality
        function searchRoutines(term) {
            if (!term) {
                renderRoutines(routines);
                return;
            }

            const terms = term.toLowerCase().split(',').map(t => t.trim()).filter(t => t);
            const filtered = routines.filter(routine => {
                return terms.every(t => {
                    if (routine.name.toLowerCase().includes(t)) return true;
                    return routine.exercises?.some(ex => 
                        ex.name?.toLowerCase().includes(t) || 
                        ex.comments?.toLowerCase().includes(t)
                    );
                });
            });

            renderRoutines(filtered);
        }

        // Handle file upload
        function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                        throw new Error("Invalid format");
                    }

                    routines = data;
                    localStorage.setItem('routines', JSON.stringify(routines));
                    renderRoutines(routines);
                    showMessage(`Loaded ${routines.length} routines`, "success");
                    saveBtn.disabled = false;
                } catch (e) {
                    console.error("Upload error:", e);
                    showMessage("Invalid JSON file", "error");
                }
            };
            reader.onerror = () => showMessage("Error reading file", "error");
            reader.readAsText(file);
        }

        // Show status message
        function showMessage(msg, type) {
            statusMessage.textContent = msg;
            statusMessage.className = `status-message ${type}`;
            setTimeout(() => {
                statusMessage.className = 'status-message';
                statusMessage.textContent = '';
            }, 3000);
        }

        // Event listeners
        searchInput.addEventListener('input', () => searchRoutines(searchInput.value));
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFileUpload(e.target.files[0]);
        });
        editBtn.addEventListener('click', editSelectedRoutine);
        deleteBtn.addEventListener('click', deleteSelectedRoutine);
        printBtn.addEventListener('click', printSelectedRoutine);
        saveBtn.addEventListener('click', saveRoutines);

        // Initialize
        document.addEventListener('DOMContentLoaded', loadRoutines);
    </script>
</body>
</html>
